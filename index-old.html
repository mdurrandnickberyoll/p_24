<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P24 Membres</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .header h2 {
            color: #667eea;
            margin: 0;
            font-size: 1.3em;
            font-weight: 500;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .input-field {
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        input[type="text"], input[type="tel"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus, input[type="tel"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            background: white;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #28a745;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .members-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .members-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .members-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }
        
        .members-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .stats {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .stats h3 {
            margin: 0;
            color: #495057;
            font-size: 1.2em;
        }
        
        .filename-display {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .filename-display strong {
            color: #667eea;
            font-size: 1.1em;
        }
        
        .status-indicator {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Liste des membres P24</h1>
            <h2 id="groupeTitle">Groupe : S√©lectionnez un groupe</h2>
        </div>
        
        <div id="statusIndicator" class="status-indicator" style="display: none;"></div>
        
        <div class="form-section">
            <div class="input-field" style="max-width: 400px; margin: 0 auto 20px auto;">
                <label for="groupeSelect">S√©lectionner le groupe *</label>
                <select id="groupeSelect" onchange="changerGroupe()" required>
                    <option value="">-- Choisir un groupe --</option>
                    <option value="prieres_en_langues">Pri√®res en langues et louanges</option>
                    <option value="sante">Sant√©</option>
                    <option value="jeunesse">Jeunesse</option>
                    <option value="salut_des_ames">Salut des √¢mes et multiblication des justes</option>
                    <option value="autorite">Autorit√©</option>
                    <option value="declarations_prophetiquse">√©clarations proph√©tiques</option>
                    <option value="economie">Economie</option>
                    <option value="eduation">√âducations</option>
                    <option value="administration">Administrations publiques et priv√©es</option>
                    <option value="paix_et_securite">Paix et s√©curit√©</option>
                    <option value="autre">Autre (personnalis√©)</option>
                </select>
            </div>
            
            <div class="input-field" id="autreGroupe" style="max-width: 400px; margin: 0 auto 20px auto; display: none;">
                <label for="groupePersonnalise">Nom du groupe personnalis√©</label>
                <input type="text" id="groupePersonnalise" placeholder="Entrez le nom du groupe">
            </div>
        </div>
        
        <div class="filename-display" id="filenameDisplay" style="display: none;">
            <strong>Nom du fichier :</strong> <span id="filenameText">p24_membres_groupe.xlsx</span>
        </div>
        
        <div class="stats">
            <h3>Nombre total de membres : <span id="memberCount">0</span> | Affich√©s : <span id="filteredCount">0</span></h3>
        </div>
        
        <div class="form-section" id="filterSection" style="display: none;">
            <div class="input-group">
                <div class="input-field">
                    <label for="filtreRecherche">üîç Rechercher dans les membres</label>
                    <input type="text" id="filtreRecherche" placeholder="Rechercher par nom, pr√©nom, t√©l√©phone, pays ou ville..." oninput="filtrerMembres()">
                </div>
                <div class="input-field">
                    <label for="filtrePays">Filtrer par pays</label>
                    <select id="filtrePays" onchange="filtrerMembres()">
                        <option value="">Tous les pays</option>
                    </select>
                </div>
                <div class="input-field">
                    <label for="filtreVille">Filtrer par ville</label>
                    <select id="filtreVille" onchange="filtrerMembres()">
                        <option value="">Toutes les villes</option>
                    </select>
                </div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn-secondary" onclick="reinitialiserFiltres()">
                    üîÑ R√©initialiser les filtres
                </button>
            </div>
        </div>
        
        <div class="form-section">
            <div class="input-group">
                <div class="input-field">
                    <label for="nom">Nom(s) *</label>
                    <input type="text" id="nom" placeholder="Entrez le(s) nom(s)" required>
                </div>
                <div class="input-field">
                    <label for="prenom">Pr√©nom(s) *</label>
                    <input type="text" id="prenom" placeholder="Entrez le(s) pr√©nom(s)" required>
                </div>
                <div class="input-field">
                    <label for="telephone">T√©l√©phone(s)</label>
                    <input type="tel" id="telephone" placeholder="Ex: +242 06 123 45 67">
                </div>
                <div class="input-field">
                    <label for="pays">Pays</label>
                    <input type="text" id="pays" placeholder="Ex: R√©publique du Congo">
                </div>
                <div class="input-field">
                    <label for="ville">Ville(s)</label>
                    <input type="text" id="ville" placeholder="Ex: Brazzaville">
                </div>
            </div>
            
            <div class="btn-group">
                <button type="button" class="btn-primary" onclick="ajouterMembre()">
                    ‚ûï Ajouter le membre
                </button>
                <button type="button" class="btn-secondary" onclick="exporterExcel()">
                    üìä Exporter vers Excel
                </button>
                <button type="button" class="btn-danger" onclick="viderListe()">
                    üóëÔ∏è Vider la liste
                </button>
                <button type="button" class="btn-secondary" onclick="synchroniserBD()">
                    üîÑ Synchroniser BD
                </button>
            </div>
        </div>
        
        <div id="tableContainer">
            <table class="members-table" id="membersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nom(s)</th>
                        <th>Pr√©nom(s)</th>
                        <th>T√©l√©phone(s)</th>
                        <th>Pays</th>
                        <th>Ville(s)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="membersBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Configuration JSON_BIN
        const JSON_BIN_CONFIG = {
            masterKey: '$2a$10$Cc7xaeGq46XKvupNsBzDHuup.4sp7OZPhYi7xn6m0qgimz4Nz4f9u',
            binId: '6857ef548960c979a5af0559',
            baseUrl: 'https://api.jsonbin.io/v3'
        };

        // Variables globales
        let membres = [];
        let membresFiltres = [];
        let groupeActuel = '';
        let nomGroupeActuel = '';

        const groupes = {
            'prieres_en_langues': 'Pri√®res en langues et louanges',
            'sante': 'Sant√©',
            'jeunesse': 'Jeunesse',
            'salut_des_ames': 'Salut des √¢mes et multiblication des justes',
            'autorite': 'Autorit√©',
            'declarations_prophetiquse': 'D√©clarations proph√©tiques',
            'economie': 'Economie',
            'eduation': '√âducations',
            'administration': 'Administrations publiques et priv√©es',
            'paix_et_securite': 'Paix et s√©curit√©'
        };

        // Fonction pour cr√©er et g√©rer les loaders
        function createLoader(elementId, message = 'Chargement...') {
            const element = document.getElementById(elementId);
            if (!element) return null;
            
            const loader = document.createElement('div');
            loader.className = 'loader-overlay';
            loader.innerHTML = `
                <div class="loader-content">
                    <div class="spinner"></div>
                    <p class="loader-message">${message}</p>
                </div>
            `;
            
            element.style.position = 'relative';
            element.appendChild(loader);
            
            return {
                updateMessage: (newMessage) => {
                    const messageEl = loader.querySelector('.loader-message');
                    if (messageEl) messageEl.textContent = newMessage;
                },
                remove: () => {
                    if (loader.parentNode) {
                        loader.parentNode.removeChild(loader);
                    }
                }
            };
        }

        // Fonction pour cr√©er un loader global
        function createGlobalLoader(message = 'Chargement...') {
            const loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.className = 'global-loader-overlay';
            loader.innerHTML = `
                <div class="global-loader-content">
                    <div class="spinner large"></div>
                    <p class="global-loader-message">${message}</p>
                </div>
            `;
            
            document.body.appendChild(loader);
            
            return {
                updateMessage: (newMessage) => {
                    const messageEl = loader.querySelector('.global-loader-message');
                    if (messageEl) messageEl.textContent = newMessage;
                },
                remove: () => {
                    if (loader.parentNode) {
                        loader.parentNode.removeChild(loader);
                    }
                }
            };
        }

        // Fonction pour cr√©er un loader sur un bouton
        function createButtonLoader(buttonElement, message = 'Chargement...') {
            if (!buttonElement) return null;
            
            const originalText = buttonElement.innerHTML;
            const originalDisabled = buttonElement.disabled;
            
            buttonElement.disabled = true;
            buttonElement.innerHTML = `
                <div class="button-loader">
                    <div class="spinner small"></div>
                    <span>${message}</span>
                </div>
            `;
            
            return {
                updateMessage: (newMessage) => {
                    const messageEl = buttonElement.querySelector('.button-loader span');
                    if (messageEl) messageEl.textContent = newMessage;
                },
                remove: () => {
                    buttonElement.disabled = originalDisabled;
                    buttonElement.innerHTML = originalText;
                }
            };
        }

        // Classe pour g√©rer la base de donn√©es
        class P24Database {
            constructor() {
                this.data = {
                    groupes: {},
                    metadata: {
                        version: '1.0',
                        derniereMiseAJour: new Date().toISOString(),
                        totalMembres: 0
                    }
                };
                this.isLoading = false;
                this.loadFromJSONBin();
            }

            async loadFromJSONBin() {
                let globalLoader = null;
                try {
                    this.isLoading = true;
                    globalLoader = createGlobalLoader('Chargement de la base de donn√©es...');
                    this.showStatus('Chargement des donn√©es...', 'warning');
                    
                    const response = await fetch(`${JSON_BIN_CONFIG.baseUrl}/b/${JSON_BIN_CONFIG.binId}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': JSON_BIN_CONFIG.masterKey
                        }
                    });

                    if (response.ok) {
                        globalLoader.updateMessage('Traitement des donn√©es...');
                        const result = await response.json();
                        this.data = result.record || this.data;
                        console.log('Base de donn√©es charg√©e depuis JSON_BIN');
                        this.showStatus('Donn√©es charg√©es avec succ√®s', 'success');
                    } else {
                        throw new Error('Erreur lors du chargement');
                    }
                } catch (error) {
                    console.warn('Erreur lors du chargement:', error);
                    this.showStatus('Erreur de chargement, utilisation des donn√©es par d√©faut', 'error');
                    this.createEmptyDatabase();
                } finally {
                    this.isLoading = false;
                    if (globalLoader) {
                        setTimeout(() => globalLoader.remove(), 500);
                    }
                }
            }

            async saveToJSONBin() {
                let statusLoader = null;
                try {
                    statusLoader = createLoader('statusIndicator', 'Sauvegarde...');
                    this.showStatus('Sauvegarde en cours...', 'warning');
                    
                    this.data.metadata.derniereMiseAJour = new Date().toISOString();
                    this.data.metadata.totalMembres = this.getTotalMembers();
                    
                    const response = await fetch(`${JSON_BIN_CONFIG.baseUrl}/b/${JSON_BIN_CONFIG.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSON_BIN_CONFIG.masterKey
                        },
                        body: JSON.stringify(this.data)
                    });

                    if (response.ok) {
                        console.log('Base de donn√©es sauvegard√©e sur JSON_BIN');
                        this.showStatus('Donn√©es sauvegard√©es avec succ√®s', 'success');
                        return true;
                    } else {
                        throw new Error('Erreur lors de la sauvegarde');
                    }
                } catch (error) {
                    console.error('Erreur lors de la sauvegarde:', error);
                    this.showStatus('Erreur lors de la sauvegarde', 'error');
                    return false;
                } finally {
                    if (statusLoader) {
                        setTimeout(() => statusLoader.remove(), 500);
                    }
                }
            }

            showStatus(message, type) {
                const indicator = document.getElementById('statusIndicator');
                indicator.className = `status-indicator status-${type}`;
                indicator.textContent = message;
                indicator.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 3000);
                }
            }

            createEmptyDatabase() {
                this.data = {
                    groupes: {},
                    metadata: {
                        version: '1.0',
                        derniereMiseAJour: new Date().toISOString(),
                        totalMembres: 0
                    }
                };
            }

            getTotalMembers() {
                let total = 0;
                Object.values(this.data.groupes).forEach(groupe => {
                    if (groupe.membres) {
                        total += groupe.membres.length;
                    }
                });
                return total;
            }

            async ajouterMembre(groupeId, nomGroupe, membre) {
                if (this.isLoading) {
                    this.showStatus('Veuillez patienter, chargement en cours...', 'warning');
                    return null;
                }

                if (!this.data.groupes[groupeId]) {
                    this.data.groupes[groupeId] = {
                        nom: nomGroupe,
                        membres: [],
                        dateCreation: new Date().toISOString()
                    };
                }

                membre.id = Date.now() + Math.random();
                membre.dateAjout = new Date().toISOString();
                
                this.data.groupes[groupeId].membres.push(membre);
                this.data.groupes[groupeId].derniereMiseAJour = new Date().toISOString();
                
                await this.saveToJSONBin();
                return membre;
            }

            async supprimerMembre(groupeId, membreId) {
                if (this.data.groupes[groupeId]) {
                    this.data.groupes[groupeId].membres = this.data.groupes[groupeId].membres.filter(
                        m => m.id !== membreId
                    );
                    this.data.groupes[groupeId].derniereMiseAJour = new Date().toISOString();
                    await this.saveToJSONBin();
                    return true;
                }
                return false;
            }

            async viderGroupe(groupeId) {
                if (this.data.groupes[groupeId]) {
                    this.data.groupes[groupeId].membres = [];
                    this.data.groupes[groupeId].derniereMiseAJour = new Date().toISOString();
                    await this.saveToJSONBin();
                    return true;
                }
                return false;
            }

            getMembres(groupeId) {
                return this.data.groupes[groupeId]?.membres || [];
            }

            async synchroniserBD() {
                let syncLoader = null;
                try {
                    const syncButton = document.querySelector('button[onclick="synchroniserBD()"]');
                    syncLoader = createButtonLoader(syncButton, 'Synchronisation...');
                    
                    this.showStatus('Synchronisation en cours...', 'warning');
                    await this.loadFromJSONBin();
                    
                    if (groupeActuel) {
                        membres = this.getMembres(groupeActuel);
                        membresFiltres = [...membres];
                        afficherMembres();
                        mettreAJourFiltres();
                    }
                    
                    this.showStatus('Synchronisation termin√©e', 'success');
                    return true;
                } catch (error) {
                    this.showStatus('Erreur de synchronisation', 'error');
                    return false;
                } finally {
                    if (syncLoader) {
                        setTimeout(() => syncLoader.remove(), 500);
                    }
                }
            }
        }

        // Instance globale de la base de donn√©es
        let database = new P24Database();

        // Fonctions principales
        async function ajouterMembre() {
            if (!nomGroupeActuel) {
                alert('Veuillez d\'abord s√©lectionner un groupe.');
                return;
            }
            
            const nom = document.getElementById('nom').value.trim();
            const prenom = document.getElementById('prenom').value.trim();
            const telephone = document.getElementById('telephone').value.trim();
            const pays = document.getElementById('pays').value.trim();
            const ville = document.getElementById('ville').value.trim();
            
            if (!nom || !prenom) {
                alert('Veuillez remplir au moins les champs Nom et Pr√©nom.');
                return;
            }
            
            const addButton = document.querySelector('button[onclick="ajouterMembre()"]');
            const buttonLoader = createButtonLoader(addButton, 'Ajout en cours...');
            
            try {
                const membre = { nom, prenom, telephone, pays, ville };
                
                const nouveauMembre = await database.ajouterMembre(groupeActuel, nomGroupeActuel, membre);
                if (nouveauMembre) {
                    membres = database.getMembres(groupeActuel);
                    membresFiltres = [...membres];
                    
                    afficherMembres();
                    mettreAJourFiltres();
                    viderFormulaire();
                    
                    const rechercheValeur = document.getElementById('filtreRecherche').value;
                    const paysFiltre = document.getElementById('filtrePays').value;
                    const villeFiltre = document.getElementById('filtreVille').value;
                    
                    if (rechercheValeur || paysFiltre || villeFiltre) {
                        filtrerMembres();
                    }
                }
            } finally {
                if (buttonLoader) {
                    setTimeout(() => buttonLoader.remove(), 500);
                }
            }
        }

        async function supprimerMembre(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce membre ?')) {
                const deleteButton = event.target;
                const buttonLoader = createButtonLoader(deleteButton, 'Suppression...');
                
                try {
                    await database.supprimerMembre(groupeActuel, id);
                    membres = database.getMembres(groupeActuel);
                    filtrerMembres();
                    mettreAJourFiltres();
                } finally {
                    if (buttonLoader) {
                        setTimeout(() => buttonLoader.remove(), 500);
                    }
                }
            }
        }

        async function viderListe() {
            if (membres.length === 0) {
                alert('La liste est d√©j√† vide.');
                return;
            }
            
            if (confirm('√ätes-vous s√ªr de vouloir vider toute la liste ?')) {
                const clearButton = document.querySelector('button[onclick="viderListe()"]');
                const buttonLoader = createButtonLoader(clearButton, 'Suppression...');
                
                try {
                    await database.viderGroupe(groupeActuel);
                    membres = [];
                    membresFiltres = [];
                    afficherMembres();
                    mettreAJourFiltres();
                } finally {
                    if (buttonLoader) {
                        setTimeout(() => buttonLoader.remove(), 500);
                    }
                }
            }
        }

        async function synchroniserBD() {
            await database.synchroniserBD();
        }

        function changerGroupe() {
            const select = document.getElementById('groupeSelect');
            const autreGroupe = document.getElementById('autreGroupe');
            const groupeTitle = document.getElementById('groupeTitle');
            const filenameDisplay = document.getElementById('filenameDisplay');
            const filenameText = document.getElementById('filenameText');
            const filterSection = document.getElementById('filterSection');
            
            const groupeLoader = createLoader('tableContainer', 'Chargement du groupe...');
            
            setTimeout(() => {
                try {
                    groupeActuel = select.value;
                    
                    if (groupeActuel === 'autre') {
                        autreGroupe.style.display = 'block';
                        document.getElementById('groupePersonnalise').focus();
                        filenameDisplay.style.display = 'none';
                        filterSection.style.display = 'none';
                        nomGroupeActuel = '';
                        membres = [];
                        membresFiltres = [];
                    } else if (groupeActuel === '') {
                        autreGroupe.style.display = 'none';
                        groupeTitle.textContent = 'Groupe : S√©lectionnez un groupe';
                        filenameDisplay.style.display = 'none';
                        filterSection.style.display = 'none';
                        nomGroupeActuel = '';
                        membres = [];
                        membresFiltres = [];
                    } else {
                        autreGroupe.style.display = 'none';
                        nomGroupeActuel = groupes[groupeActuel];
                        groupeTitle.textContent = `Groupe : ${nomGroupeActuel}`;
                        
                        const nomFichier = `p24_membres_${groupeActuel}.xlsx`;
                        filenameText.textContent = nomFichier;
                        filenameDisplay.style.display = 'block';
                        filterSection.style.display = 'block';
                        
                        membres = database.getMembres(groupeActuel);
                        membresFiltres = [...membres];
                        mettreAJourFiltres();
                    }
                    
                    afficherMembres();
                } finally {
                    if (groupeLoader) {
                        setTimeout(() => groupeLoader.remove(), 300);
                    }
                }
            }, 200);
        }

        function mettreAJourFiltres() {
            const filtrePays = document.getElementById('filtrePays');
            const filtreVille = document.getElementById('filtreVille');
            
            const filterLoader = createLoader('filterSection', 'Mise √† jour des filtres...');
            
            setTimeout(() => {
                try {
                    const paysUniques = [...new Set(membres.filter(m => m.pays).map(m => m.pays))].sort();
                    const villesUniques = [...new Set(membres.filter(m => m.ville).map(m => m.ville))].sort();
                    
                    filtrePays.innerHTML = '<option value="">Tous les pays</option>';
                    filtreVille.innerHTML = '<option value="">Toutes les villes</option>';
                    
                    paysUniques.forEach(pays => {
                        const option = document.createElement('option');
                        option.value = pays;
                        option.textContent = pays;
                        filtrePays.appendChild(option);
                    });
                    
                    villesUniques.forEach(ville => {
                        const option = document.createElement('option');
                        option.value = ville;
                        option.textContent = ville;
                        filtreVille.appendChild(option);
                    });
                } finally {
                    if (filterLoader) {
                        setTimeout(() => filterLoader.remove(), 200);
                    }
                }
            }, 100);
        }

        function filtrerMembres() {
            const rechercheValeur = document.getElementById('filtreRecherche').value.toLowerCase();
            const paysFiltre = document.getElementById('filtrePays').value;
            const villeFiltre = document.getElementById('filtreVille').value;
            
            const tableLoader = createLoader('tableContainer', 'Filtrage en cours...');
            
            setTimeout(() => {
                try {
                    membresFiltres = membres.filter(membre => {
                        const correspondRecherche = !rechercheValeur || 
                            membre.nom.toLowerCase().includes(rechercheValeur) ||
                            membre.prenom.toLowerCase().includes(rechercheValeur) ||
                            (membre.telephone && membre.telephone.toLowerCase().includes(rechercheValeur)) ||
                            (membre.pays && membre.pays.toLowerCase().includes(rechercheValeur)) ||
                            (membre.ville && membre.ville.toLowerCase().includes(rechercheValeur));
                        
                        const correspondPays = !paysFiltre || membre.pays === paysFiltre;
                        const correspondVille = !villeFiltre || membre.ville === villeFiltre;
                        
                        return correspondRecherche && correspondPays && correspondVille;
                    });
                    
                    afficherMembres();
                } finally {
                    if (tableLoader) {
                        setTimeout(() => tableLoader.remove(), 200);
                    }
                }
            }, 100);
        }

        function reinitialiserFiltres() {
            document.getElementById('filtreRecherche').value = '';
            document.getElementById('filtrePays').value = '';
            document.getElementById('filtreVille').value = '';
            membresFiltres = [...membres];
            afficherMembres();
        }

        function afficherMembres() {
            const membersTable = document.getElementById('membersTable');
            const membersBody = document.getElementById('membersBody');
            const memberCount = document.getElementById('memberCount');
            const filteredCount = document.getElementById('filteredCount');
            
            membersBody.innerHTML = '';
            
            if (membresFiltres.length === 0 && membres.length > 0) {
                membresFiltres = [...membres];
            }
            
            memberCount.textContent = membres.length;
            filteredCount.textContent = membresFiltres.length;
            
            if (membres.length === 0) {
                membersTable.style.display = 'none';
                return;
            }
            
            membersTable.style.display = 'table';
            
            membresFiltres.forEach((membre, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${membre.nom}</td>
                    <td>${membre.prenom}</td>
                    <td>${membre.telephone || '-'}</td>
                    <td>${membre.pays || '-'}</td>
                    <td>${membre.ville || '-'}</td>
                    <td>
                        <button class="delete-btn" onclick="supprimerMembre(${membre.id})">
                            üóëÔ∏è Suppr.
                        </button>
                    </td>
                `;
                membersBody.appendChild(row);
            });
        }

        function viderFormulaire() {
            document.getElementById('nom').value = '';
            document.getElementById('prenom').value = '';
            document.getElementById('telephone').value = '';
            document.getElementById('pays').value = '';
            document.getElementById('ville').value = '';
            document.getElementById('nom').focus();
        }

        function exporterExcel() {
            if (membres.length === 0) {
                alert('Aucun membre √† exporter.');
                return;
            }
            
            const exportButton = document.querySelector('button[onclick="exporterExcel()"]');
            const buttonLoader = createButtonLoader(exportButton, 'Export...');
            
            setTimeout(() => {
                try {
                    const donneesExport = membres.map((membre, index) => ({
                        'N¬∞': index + 1,
                        'Nom(s)': membre.nom,
                        'Pr√©nom(s)': membre.prenom,
                        'T√©l√©phone(s)': membre.telephone || '',
                        'Pays': membre.pays || '',
                        'Ville(s)': membre.ville || ''
                    }));
                    
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(donneesExport);
                    
                    const colWidths = [
                        {wch: 5}, {wch: 20}, {wch: 20}, {wch: 20}, {wch: 20}, {wch: 20}
                    ];
                    ws['!cols'] = colWidths;
                    
                    XLSX.utils.book_append_sheet(wb, ws, 'Membres');
                    
                    const nomFichier = groupeActuel === 'autre' ? 
                        `p24_membres_${nomGroupeActuel.toLowerCase().replace(/[^a-z0-9]/g, '_')}.xlsx` :
                        `p24_membres_${groupeActuel}.xlsx`;
                    
                    XLSX.writeFile(wb, nomFichier);
                } finally {
                    if (buttonLoader) {
                        setTimeout(() => buttonLoader.remove(), 1000);
                    }
                }
            }, 500);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Ajouter les styles CSS pour les loaders
            const style = document.createElement('style');
            style.textContent = `
                .loader-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(255, 255, 255, 0.9);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    border-radius: 10px;
                }
                
                .global-loader-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                }
                
                .loader-content, .global-loader-content {
                    text-align: center;
                    color: #667eea;
                }
                
                .global-loader-content {
                    color: white;
                }
                
                .spinner {
                    border: 3px solid #f3f3f3;
                    border-top: 3px solid #667eea;
                    border-radius: 50%;
                    width: 30px;
                    height: 30px;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 10px;
                }
                
                .spinner.large {
                    width: 50px;
                    height: 50px;
                    border-width: 5px;
                }
                
                .spinner.small {
                    width: 16px;
                    height: 16px;
                    border-width: 2px;
                    margin: 0 5px 0 0;
                    display: inline-block;
                }
                
                .button-loader {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .loader-message, .global-loader-message {
                    margin: 0;
                    font-weight: 500;
                    font-size: 14px;
                }
                
                .global-loader-message {
                    font-size: 16px;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                .button-loader .spinner.small {
                    border-top-color: white;
                }
            `;
            document.head.appendChild(style);
            
            setTimeout(() => {
                document.getElementById('groupeSelect').focus();
            }, 1000);
            
            document.getElementById('groupePersonnalise').addEventListener('input', function() {
                const valeur = this.value.trim();
                const groupeTitle = document.getElementById('groupeTitle');
                const filenameDisplay = document.getElementById('filenameDisplay');
                const filenameText = document.getElementById('filenameText');
                const filterSection = document.getElementById('filterSection');
                
                const inputLoader = createLoader('autreGroupe', 'Chargement...');
                
                setTimeout(() => {
                    try {
                        if (valeur) {
                            nomGroupeActuel = valeur;
                            groupeTitle.textContent = `Groupe : ${valeur}`;
                            
                            const nomFichier = `p24_membres_${valeur.toLowerCase().replace(/[^a-z0-9]/g, '_')}.xlsx`;
                            filenameText.textContent = nomFichier;
                            filenameDisplay.style.display = 'block';
                            filterSection.style.display = 'block';
                            
                            const groupeId = `custom_${valeur.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
                            groupeActuel = groupeId;
                            
                            membres = database.getMembres(groupeId);
                            membresFiltres = [...membres];
                            afficherMembres();
                            mettreAJourFiltres();
                        } else {
                            groupeTitle.textContent = 'Groupe : Autre (personnalis√©)';
                            filenameDisplay.style.display = 'none';
                            filterSection.style.display = 'none';
                            nomGroupeActuel = '';
                            membres = [];
                            membresFiltres = [];
                            afficherMembres();
                        }
                    } finally {
                        if (inputLoader) {
                            setTimeout(() => inputLoader.remove(), 200);
                        }
                    }
                }, 300);
            });
        });

        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id !== 'groupeSelect' && e.target.id !== 'groupePersonnalise' && 
                !e.target.id.startsWith('filtre')) {
                ajouterMembre();
            }
        });


        // Donn√©es des pays et villes
    const paysVillesData = {
        "R√©publique du Congo": [
            "Brazzaville", "Pointe-Noire", "Dolisie", "Nkayi", "Mossendjo", 
            "Ouesso", "Madingou", "Owando", "Sibiti", "Gamboma", "Impfondo",
            "Kinkala", "Makoua", "Djambala", "Ewo", "Boundji"
        ],
        "R√©publique d√©mocratique du Congo": [
            "Kinshasa", "Lubumbashi", "Mbuji-Mayi", "Kisangani", "Kananga",
            "Likasi", "Kolwezi", "Tshikapa", "Beni", "Bukavu", "Mwene-Ditu",
            "Kikwit", "Matadi", "Uvira", "Butembo", "Gandajika", "Kalemie",
            "Goma", "Kindu", "Isiro", "Bandundu", "Gemena", "Ilebo",
            "Bunia", "Bumba", "Mbandaka", "Kamina", "Lisala", "Kongolo",
            "Kabinda", "Kenge", "Dongo", "Kundu", "Luebo", "Boende",
            "Basankusu", "Bafwasende", "Kabalo", "Kipushi", "Lodja",
            "Kaniama", "Kasongo", "Pweto", "Moba", "Manono", "Sandoa",
            "Dilolo", "Kamonia", "Tshimbulu", "Lusambo"
        ],
        "Cameroun": [
            "Yaound√©", "Douala", "Garoua", "Bafoussam", "Bamenda", "Maroua",
            "Nkongsamba", "Foumban", "Kumba", "Ed√©a", "Loum", "Kumbo",
            "Mbouda", "Dschang", "Limb√©", "Bertoua", "Kribi", "Sangm√©lima",
            "Mbalmayo", "Bafang", "Ebolowa", "Guider", "Ngaound√©r√©", "Mokolo",
            "Ka√©l√©", "Wum", "Batouri", "Tibati", "Fundong", "Nanga-Eboko"
        ],
        "Gabon": [
            "Libreville", "Port-Gentil", "Franceville", "Oyem", "Moanda",
            "Mouila", "Lambar√©n√©", "Tchibanga", "Koulamoutou", "Makokou",
            "Bitam", "Gamba", "Mayumba", "Mitzic", "Ndend√©", "Okondja",
            "Boou√©", "Lastoursville", "Ombou√©", "Fougamou"
        ],
        "Guin√©e √©quatoriale": [
            "Malabo", "Bata", "Ebebiyin", "Aconibe", "A√±isoc", "Luba",
            "Evinayong", "Mongomo", "Mengomey√©n", "Acurenam", "Cogo",
            "Mbini", "Micomeseng", "Nsok", "Ayene", "Machinda", "R√≠o Campo"
        ],
        "Tchad": [
            "N'Djam√©na", "Moundou", "Sarh", "Ab√©ch√©", "Kelo", "Koumra",
            "Pala", "Am Timan", "Bongor", "Doba", "Mongo", "Goz Be√Øda",
            "La√Ø", "Faya-Largeau", "Ati", "Oum Hadjer", "Biltine", "Aozou",
            "Mao", "Massakory", "Moussoro", "Gounou-Gaya", "Kyab√©", "Fianga"
        ],
        "R√©publique centrafricaine": [
            "Bangui", "Bimbo", "Berb√©rati", "Carnot", "Bambari", "Bouar",
            "Bossangoa", "Bangassou", "Nola", "Kaga-Bandoro", "Bria",
            "Sibut", "Mba√Øki", "Gamboula", "Mobaye", "Bakouma", "Batangafo",
            "Bozoum", "Zemio", "Obo", "Rafa√Ø", "Yaloke", "Bocaranga"
        ],
        "Angola": [
            "Luanda", "Huambo", "Lobito", "Benguela", "Kuito", "Lubango",
            "Malanje", "Namibe", "Soyo", "Cabinda", "U√≠ge", "Saurimo",
            "Sumbe", "Menongue", "Luena", "Caxito", "Kuando Kubango",
            "Tombua", "Longonjo", "Caluquembe", "Camacupa", "Dondo",
            "Ndalatando", "Ondjiva", "Cuvelai", "M'banza-Kongo"
        ],
        "France": [
            "Paris", "Marseille", "Lyon", "Toulouse", "Nice", "Nantes",
            "Montpellier", "Strasbourg", "Bordeaux", "Lille", "Rennes",
            "Reims", "Saint-√âtienne", "Toulon", "Le Havre", "Grenoble",
            "Dijon", "Angers", "N√Æmes", "Villeurbanne", "Clermont-Ferrand",
            "Aix-en-Provence", "Brest", "Limoges", "Tours", "Amiens",
            "Perpignan", "Metz", "Besan√ßon", "Orl√©ans", "Caen", "Mulhouse",
            "Rouen", "Nancy", "Argenteuil", "Montreuil", "Saint-Denis",
            "Roubaix", "Tourcoing", "Avignon", "Cr√©teil", "Poitiers"
        ],
        "Belgique": [
            "Bruxelles", "Anvers", "Gand", "Charleroi", "Li√®ge", "Bruges",
            "Namur", "Louvain", "Mons", "Aalst", "Malines", "La Louvi√®re",
            "Mouscron", "Courtrai", "Hasselt", "Saint-Nicolas", "Ostende",
            "Genk", "Seraing", "Roulers", "Tournai", "Verviers", "Dendermonde",
            "Beringen", "Turnhout", "Vilvoorde", "Lokeren", "Sint-Truiden"
        ],
        "Canada": [
            "Toronto", "Montr√©al", "Vancouver", "Calgary", "Edmonton",
            "Ottawa", "Winnipeg", "Qu√©bec", "Hamilton", "Kitchener",
            "London", "Victoria", "Halifax", "Oshawa", "Windsor",
            "Saskatoon", "St. Catharines", "Regina", "Sherbrooke",
            "Barrie", "Kelowna", "Abbotsford", "Sudbury", "Kingston",
            "Saguenay", "Trois-Rivi√®res", "Guelph", "Cambridge", "Whitby"
        ],
        "√âtats-Unis": [
            "New York", "Los Angeles", "Chicago", "Houston", "Phoenix",
            "Philadelphia", "San Antonio", "San Diego", "Dallas", "San Jose",
            "Austin", "Jacksonville", "Fort Worth", "Columbus", "Charlotte",
            "San Francisco", "Indianapolis", "Seattle", "Denver", "Washington",
            "Boston", "El Paso", "Nashville", "Detroit", "Oklahoma City",
            "Portland", "Las Vegas", "Memphis", "Louisville", "Baltimore",
            "Milwaukee", "Albuquerque", "Tucson", "Fresno", "Sacramento",
            "Kansas City", "Mesa", "Atlanta", "Omaha", "Colorado Springs",
            "Raleigh", "Miami", "Virginia Beach", "Oakland", "Minneapolis",
            "Tulsa", "Arlington", "Tampa", "New Orleans", "Wichita"
        ],
        "Suisse": [
            "Zurich", "Gen√®ve", "B√¢le", "Lausanne", "Berne", "Winterthour",
            "Lucerne", "Saint-Gall", "Lugano", "Bienne", "Thoune", "K√∂niz",
            "La Chaux-de-Fonds", "Schaffhouse", "Fribourg", "Chur", "Neuch√¢tel",
            "Uster", "Sion", "Emmen", "Yverdon-les-Bains", "Zoug", "D√ºbendorf"
        ],
        "S√©n√©gal": [
            "Dakar", "Thi√®s", "Kaolack", "Ziguinchor", "Saint-Louis",
            "Mbour", "Rufisque", "Diourbel", "Louga", "Tambacounda",
            "Kolda", "Fatick", "K√©dougou", "Matam", "S√©dhiou", "Pikine",
            "Gu√©diawaye", "Touba", "M'Bour", "Tivaouane", "Mback√©",
            "Joal-Fadiouth", "Podor", "Richard-Toll", "Dagana"
        ],
        "C√¥te d'Ivoire": [
            "Abidjan", "Bouak√©", "Daloa", "Yamoussoukro", "Korhogo",
            "San-P√©dro", "Man", "Divo", "Gagnoa", "Anyama", "Abengourou",
            "Agboville", "Grand-Bassam", "Dabou", "Grand-Lahou", "Issia",
            "Sinfra", "Soubr√©", "Adzop√©", "Bongouanou", "Tanda", "Boundiali",
            "Odienn√©", "S√©gu√©la", "Katiola", "Ferkess√©dougou", "Bouna"
        ],
        "Mali": [
            "Bamako", "Sikasso", "Mopti", "Koutiala", "S√©gou", "Kayes",
            "Gao", "Tombouctou", "Kati", "Markala", "Kolokani", "Djenn√©",
            "Bandiagara", "Bla", "San", "Niono", "Yorosso", "Nioro du Sahel",
            "Ansongo", "Dire", "Goundam", "Niafunk√©", "Rharous", "Bourem"
        ],
        "Burkina Faso": [
            "Ouagadougou", "Bobo-Dioulasso", "Koudougou", "Ouahigouya",
            "Banfora", "Kaya", "Tenkodogo", "Orodara", "Fada N'Gourma",
            "Ziniar√©", "Kombissiri", "R√©o", "Gaoua", "Dori", "Manga",
            "Djibo", "Kongoussi", "Tougan", "Titao", "Yako", "Solenzo"
        ],
        "Niger": [
            "Niamey", "Zinder", "Maradi", "Agadez", "Tahoua", "Dosso",
            "Arlit", "Birni-N'Konni", "Tessaoua", "Gaya", "Madaoua",
            "Tillab√©ri", "Ayorou", "Filingu√©", "Tchin-Tabaraden", "Abalak",
            "Ill√©la", "Ke√Øta", "Magaria", "Matameye", "Mirriah", "Dakoro"
        ]
    };

    // Variables pour stocker les √©l√©ments select
    let paysSelect, villeSelect;

    // Fonction pour initialiser les s√©lecteurs de pays et ville
    function initialiserSelectPaysVille() {
        // Cr√©er les √©l√©ments select pour pays et ville
        const paysField = document.getElementById('pays');
        const villeField = document.getElementById('ville');
        
        if (paysField && paysField.tagName === 'INPUT') {
            // Remplacer l'input pays par un select
            const paysContainer = paysField.parentElement;
            const paysLabel = paysContainer.querySelector('label');
            
            const paysSelectElement = document.createElement('select');
            paysSelectElement.id = 'pays';
            paysSelectElement.name = 'pays';
            paysSelectElement.className = paysField.className;
            paysSelectElement.innerHTML = '<option value="">S√©lectionnez un pays</option>';
            
            // Ajouter les options de pays
            Object.keys(paysVillesData).sort().forEach(pays => {
                const option = document.createElement('option');
                option.value = pays;
                option.textContent = pays;
                paysSelectElement.appendChild(option);
            });
            
            // Remplacer l'input par le select
            paysContainer.replaceChild(paysSelectElement, paysField);
            paysSelect = paysSelectElement;
            
            // Ajouter l'√©v√©nement de changement
            paysSelect.addEventListener('change', function() {
                mettreAJourVilles(this.value);
            });
        }
        
        if (villeField && villeField.tagName === 'INPUT') {
            // Remplacer l'input ville par un select
            const villeContainer = villeField.parentElement;
            const villeLabel = villeContainer.querySelector('label');
            
            const villeSelectElement = document.createElement('select');
            villeSelectElement.id = 'ville';
            villeSelectElement.name = 'ville';
            villeSelectElement.className = villeField.className;
            villeSelectElement.innerHTML = '<option value="">S√©lectionnez d\'abord un pays</option>';
            villeSelectElement.disabled = true;
            
            // Remplacer l'input par le select
            villeContainer.replaceChild(villeSelectElement, villeField);
            villeSelect = villeSelectElement;
        }
    }

    // Fonction pour mettre √† jour les villes selon le pays s√©lectionn√©
    function mettreAJourVilles(paysSelectionne) {
        if (!villeSelect) return;
        
        // R√©initialiser le select des villes
        villeSelect.innerHTML = '';
        
        if (!paysSelectionne) {
            villeSelect.innerHTML = '<option value="">S√©lectionnez d\'abord un pays</option>';
            villeSelect.disabled = true;
            return;
        }
        
        // Ajouter l'option par d√©faut
        villeSelect.innerHTML = '<option value="">S√©lectionnez une ville</option>';
        villeSelect.disabled = false;
        
        // Ajouter les villes du pays s√©lectionn√©
        const villes = paysVillesData[paysSelectionne];
        if (villes) {
            villes.forEach(ville => {
                const option = document.createElement('option');
                option.value = ville;
                option.textContent = ville;
                villeSelect.appendChild(option);
            });
        }
    }

    // Fonction pour ajouter l'option "Autre" aux s√©lecteurs
    function ajouterOptionAutre() {
        if (paysSelect) {
            const optionAutrePays = document.createElement('option');
            optionAutrePays.value = 'autre_pays';
            optionAutrePays.textContent = 'Autre pays...';
            paysSelect.appendChild(optionAutrePays);
            
            // G√©rer la s√©lection "Autre pays"
            paysSelect.addEventListener('change', function() {
                if (this.value === 'autre_pays') {
                    const autrePays = prompt('Veuillez entrer le nom du pays :');
                    if (autrePays && autrePays.trim()) {
                        // Ajouter le nouveau pays √† la liste
                        const newOption = document.createElement('option');
                        newOption.value = autrePays.trim();
                        newOption.textContent = autrePays.trim();
                        newOption.selected = true;
                        
                        // Ins√©rer avant l'option "Autre"
                        this.insertBefore(newOption, this.lastElementChild);
                        
                        // Mettre √† jour les villes (vide pour un nouveau pays)
                        mettreAJourVillesAvecAutre(autrePays.trim());
                    } else {
                        this.value = '';
                        mettreAJourVilles('');
                    }
                } else {
                    mettreAJourVillesAvecAutre(this.value);
                }
            });
        }
    }

    // Fonction pour mettre √† jour les villes avec option "Autre"
    function mettreAJourVillesAvecAutre(paysSelectionne) {
        if (!villeSelect) return;
        
        // R√©initialiser le select des villes
        villeSelect.innerHTML = '';
        
        if (!paysSelectionne) {
            villeSelect.innerHTML = '<option value="">S√©lectionnez d\'abord un pays</option>';
            villeSelect.disabled = true;
            return;
        }
        
        // Ajouter l'option par d√©faut
        villeSelect.innerHTML = '<option value="">S√©lectionnez une ville</option>';
        villeSelect.disabled = false;
        
        // Ajouter les villes du pays s√©lectionn√©
        const villes = paysVillesData[paysSelectionne];
        if (villes) {
            villes.forEach(ville => {
                const option = document.createElement('option');
                option.value = ville;
                option.textContent = ville;
                villeSelect.appendChild(option);
            });
        }
        
        // Ajouter l'option "Autre ville"
        const optionAutreVille = document.createElement('option');
        optionAutreVille.value = 'autre_ville';
        optionAutreVille.textContent = 'Autre ville...';
        villeSelect.appendChild(optionAutreVille);
        
        // G√©rer la s√©lection "Autre ville"
        villeSelect.removeEventListener('change', gererAutreVille); // √âviter les doublons
        villeSelect.addEventListener('change', gererAutreVille);
    }

    // Fonction pour g√©rer la s√©lection "Autre ville"
    function gererAutreVille(event) {
        if (event.target.value === 'autre_ville') {
            const autreVille = prompt('Veuillez entrer le nom de la ville :');
            if (autreVille && autreVille.trim()) {
                // Ajouter la nouvelle ville √† la liste
                const newOption = document.createElement('option');
                newOption.value = autreVille.trim();
                newOption.textContent = autreVille.trim();
                newOption.selected = true;
                
                // Ins√©rer avant l'option "Autre"
                event.target.insertBefore(newOption, event.target.lastElementChild);
            } else {
                event.target.value = '';
            }
        }
    }

    // Fonction pour obtenir les valeurs s√©lectionn√©es
    function obtenirValeursSelectionnees() {
        return {
            pays: paysSelect ? paysSelect.value : '',
            ville: villeSelect ? villeSelect.value : ''
        };
    }

    // Fonction pour r√©initialiser les s√©lecteurs
    function reinitialiserSelecteurs() {
        if (paysSelect) {
            paysSelect.value = '';
        }
        if (villeSelect) {
            villeSelect.innerHTML = '<option value="">S√©lectionnez d\'abord un pays</option>';
            villeSelect.disabled = true;
        }
    }

    // Fonction pour d√©finir des valeurs dans les s√©lecteurs
    function definirValeurs(pays, ville) {
        if (paysSelect && pays) {
            // V√©rifier si le pays existe dans les options
            const optionPays = Array.from(paysSelect.options).find(option => option.value === pays);
            if (optionPays) {
                paysSelect.value = pays;
                mettreAJourVillesAvecAutre(pays);
                
                // D√©finir la ville apr√®s mise √† jour
                setTimeout(() => {
                    if (villeSelect && ville) {
                        const optionVille = Array.from(villeSelect.options).find(option => option.value === ville);
                        if (optionVille) {
                            villeSelect.value = ville;
                        }
                    }
                }, 100);
            }
        }
    }

    // Modifier la fonction viderFormulaire existante pour inclure la r√©initialisation des s√©lecteurs
    const viderFormulaireOriginal = window.viderFormulaire;
    window.viderFormulaire = function() {
        if (viderFormulaireOriginal) {
            // Appeler la fonction originale pour les autres champs
            document.getElementById('nom').value = '';
            document.getElementById('prenom').value = '';
            document.getElementById('telephone').value = '';
            document.getElementById('nom').focus();
        }
        
        // R√©initialiser les s√©lecteurs pays et ville
        reinitialiserSelecteurs();
    };

    // Modifier la fonction ajouterMembre pour utiliser les valeurs des s√©lecteurs
    const ajouterMembreOriginal = window.ajouterMembre;
    window.ajouterMembre = async function() {
        if (!nomGroupeActuel) {
            alert('Veuillez d\'abord s√©lectionner un groupe.');
            return;
        }
        
        const nom = document.getElementById('nom').value.trim();
        const prenom = document.getElementById('prenom').value.trim();
        const telephone = document.getElementById('telephone').value.trim();
        
        // Utiliser les valeurs des s√©lecteurs
        const valeurs = obtenirValeursSelectionnees();
        const pays = valeurs.pays === 'autre_pays' ? '' : valeurs.pays;
        const ville = valeurs.ville === 'autre_ville' ? '' : valeurs.ville;
        
        if (!nom || !prenom) {
            alert('Veuillez remplir au moins les champs Nom et Pr√©nom.');
            return;
        }
        
        const addButton = document.querySelector('button[onclick="ajouterMembre()"]');
        const buttonLoader = createButtonLoader(addButton, 'Ajout en cours...');
        
        try {
            const membre = { nom, prenom, telephone, pays, ville };
            
            const nouveauMembre = await database.ajouterMembre(groupeActuel, nomGroupeActuel, membre);
            if (nouveauMembre) {
                membres = database.getMembres(groupeActuel);
                membresFiltres = [...membres];
                
                afficherMembres();
                mettreAJourFiltres();
                viderFormulaire();
                
                const rechercheValeur = document.getElementById('filtreRecherche').value;
                const paysFiltre = document.getElementById('filtrePays').value;
                const villeFiltre = document.getElementById('filtreVille').value;
                
                if (rechercheValeur || paysFiltre || villeFiltre) {
                    filtrerMembres();
                }
            }
        } finally {
            if (buttonLoader) {
                setTimeout(() => buttonLoader.remove(), 500);
            }
        }
    };

    // Initialiser les s√©lecteurs quand le DOM est pr√™t
    document.addEventListener('DOMContentLoaded', function() {
        // Attendre un peu pour s'assurer que tous les √©l√©ments sont charg√©s
        setTimeout(() => {
            initialiserSelectPaysVille();
            ajouterOptionAutre();
        }, 500);
    });

    // Fonction utilitaire pour ajouter un nouveau pays/ville manuellement
    function ajouterNouveauPaysVille(nouveauPays, nouvellesVilles = []) {
        if (nouveauPays && !paysVillesData[nouveauPays]) {
            paysVillesData[nouveauPays] = nouvellesVilles;
            
            // Mettre √† jour le s√©lecteur de pays
            if (paysSelect) {
                const option = document.createElement('option');
                option.value = nouveauPays;
                option.textContent = nouveauPays;
                
                // Ins√©rer dans l'ordre alphab√©tique
                const options = Array.from(paysSelect.options);
                let inserted = false;
                for (let i = 1; i < options.length - 1; i++) { // Ignorer la premi√®re option vide et la derni√®re "Autre"
                    if (options[i].textContent > nouveauPays) {
                        paysSelect.insertBefore(option, options[i]);
                        inserted = true;
                        break;
                    }
                }
                if (!inserted) {
                    paysSelect.insertBefore(option, paysSelect.lastElementChild); // Avant "Autre"
                }
            }
        }
    }

    // Export des fonctions pour utilisation externe
    window.paysVillesUtils = {
        initialiserSelectPaysVille,
        mettreAJourVilles,
        obtenirValeursSelectionnees,
        reinitialiserSelecteurs,
        definirValeurs,
        ajouterNouveauPaysVille,
        paysVillesData
    };
    </script>
</body>
</html>    